<% content_for :title, "#{@form_definition.code} - #{@form_definition.title}" %>
<% content_for :description, "Fill out #{@form_definition.code} - #{@form_definition.title} online. Free California Small Claims Court form with guided wizard." %>

<%# Wrap entire page content in view-toggle, keyboard-shortcuts, and pdf-drawer controllers %>
<div data-controller="view-toggle keyboard-shortcuts pdf-drawer"
     data-keyboard-shortcuts-save-url-value="<%= form_path(@form_definition.code) %>"
     data-keyboard-shortcuts-preview-url-value="<%= preview_form_path(@form_definition.code) %>"
     data-keyboard-shortcuts-download-url-value="<%= download_form_path(@form_definition.code) %>">

<%# Back Link %>
<div class="mb-4">
  <%= link_to forms_path, class: "inline-flex items-center gap-1 text-primary hover:text-primary-focus transition-colors min-h-[44px] py-2" do %>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
    Back to Forms
  <% end %>
</div>

<%# Header with Title and Controls %>
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
  <%# Form Title %>
  <div>
    <h1 class="text-2xl font-bold text-base-content"><%= @form_definition.code %></h1>
    <p class="text-base-content/70"><%= @form_definition.title %></p>
  </div>

  <%# Controls Row %>
  <div class="flex flex-wrap items-center gap-4">
    <%# Wizard/Traditional Toggle %>
    <label class="flex items-center gap-2 cursor-pointer">
      <span class="text-sm text-base-content/70">Traditional</span>
      <input type="checkbox"
             class="toggle toggle-primary"
             data-view-toggle-target="toggle"
             data-action="change->view-toggle#toggle"
             <%= "checked" if @wizard_mode %>>
      <span class="text-sm text-base-content/70">Wizard</span>
    </label>

    <%# Skip Filled Toggle (authenticated users in wizard mode only) %>
    <% if user_signed_in? %>
      <label class="flex items-center gap-2 cursor-pointer <%= 'opacity-50' unless @wizard_mode %>"
             id="skip-filled-label"
             data-view-toggle-target="skipFilledLabel">
        <input type="checkbox"
               class="checkbox checkbox-primary checkbox-sm"
               data-action="change->view-toggle#toggleSkipFilled"
               data-view-toggle-target="skipFilledCheckbox"
               <%= "checked" if @skip_filled %>
               <%= "disabled" unless @wizard_mode %>>
        <span class="text-sm text-base-content/70">Skip filled</span>
      </label>
    <% end %>
  </div>
</div>

<%# Main Content - CSS Grid Layout for Side-by-Side %>
<div class="form-pdf-layout">
  <%# Form Section (Left on Desktop) %>
  <div class="form-scroll-container">
    <%= form_with model: @submission,
                  url: form_path(@form_definition.code),
                  method: :patch,
                  local: false,
                  id: "main-form",
                  data: {
                    controller: "form validation",
                    form_save_url_value: form_path(@form_definition.code),
                    validation_target: "form"
                  } do |f| %>

      <%# Wizard Mode Container %>
      <div id="wizard-container"
           class="<%= 'hidden' unless @wizard_mode %>"
           data-view-toggle-target="wizardContainer"
           data-controller="wizard"
           data-wizard-total-fields-value="<%= @wizard_fields&.count || 0 %>"
           data-wizard-skip-filled-value="<%= @skip_filled %>">

        <% if @wizard_fields.present? && @wizard_fields.any? %>
          <%# Progress Bar %>
          <%= render "forms/wizard/progress_bar" %>

          <%# Wizard Cards Container with 3D Perspective %>
          <div class="wizard-cards-container perspective-1000 min-h-[350px]">
            <% @wizard_fields.each_with_index do |field, index| %>
              <%= render "forms/wizard/card",
                         field: field,
                         form: f,
                         submission: @submission,
                         index: index %>
            <% end %>
          </div>

          <%# Navigation %>
          <%= render "forms/wizard/navigation" %>
        <% else %>
          <%# Empty State %>
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center py-12">
              <svg class="w-16 h-16 mx-auto text-success mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <h3 class="text-xl font-semibold text-base-content mb-2">All Fields Complete!</h3>
              <p class="text-base-content/70 mb-4">
                <% if @skip_filled %>
                  All required fields have been filled. You can download your form.
                <% else %>
                  This form has no fillable fields configured yet.
                <% end %>
              </p>
              <div class="flex justify-center gap-3">
                <%= link_to preview_form_path(@form_definition.code),
                            target: "_blank",
                            class: "btn btn-outline btn-primary" do %>
                  Preview PDF
                <% end %>
                <%= render "shared/download_button",
                    path: download_form_path(@form_definition.code),
                    text: "Download PDF",
                    class: "btn btn-success" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <%# Traditional Mode Container %>
      <div id="traditional-container"
           class="<%= 'hidden' if @wizard_mode %>"
           data-view-toggle-target="traditionalContainer">
        <%= render "forms/traditional_form",
                   sections: @sections,
                   form: f,
                   submission: @submission %>

        <%# Action Bar for Traditional Mode %>
        <div class="mt-6 p-4 bg-base-200 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <%= f.submit "Save",
                         class: "btn btn-primary" %>
            <span class="text-sm text-base-content/70">
              <%= @submission.completion_percentage %>% complete
            </span>
          </div>

          <div class="flex gap-3">
            <%= link_to preview_form_path(@form_definition.code),
                        target: "_blank",
                        class: "btn btn-outline gap-1 sm:btn-sm" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              Preview
            <% end %>

            <%= render "shared/download_button",
                path: download_form_path(@form_definition.code),
                text: "Download",
                class: "btn btn-success sm:btn-sm" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%# PDF Preview Section (Right on Desktop, Drawer on Mobile/Tablet) %>
  <div class="pdf-preview-container hidden md:block"
       data-pdf-drawer-target="panel">
    <%= render PdfPreviewComponent.new(form_definition: @form_definition) %>
  </div>
</div>

<%# Mobile/Tablet: PDF Preview Drawer %>
<div class="md:hidden">
  <%# Drawer Backdrop %>
  <div class="pdf-drawer-backdrop hidden"
       data-pdf-drawer-target="backdrop"
       data-action="click->pdf-drawer#close"></div>

  <%# Drawer Panel %>
  <div class="pdf-drawer-panel"
       data-pdf-drawer-target="drawer">
    <div class="pdf-drawer-header">
      <h3 class="font-semibold text-base-content">PDF Preview</h3>
      <button type="button"
              class="btn btn-ghost btn-circle min-h-[44px] min-w-[44px]"
              data-action="click->pdf-drawer#close"
              aria-label="Close preview">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="pdf-drawer-content">
      <%= render PdfPreviewComponent.new(form_definition: @form_definition, variant: "mobile") %>
    </div>
  </div>
</div>

<%# Mobile: Form Actions Bottom Sheet with swipe-to-dismiss %>
<%= render "forms/form_actions_bottom_sheet",
           form_definition: @form_definition,
           submission: @submission %>

<%# Form Info Sidebar - Collapsed on smaller screens %>
<details class="lg:hidden mt-6 collapse collapse-arrow bg-base-100 shadow rounded-lg">
  <summary class="collapse-title text-lg font-medium">
    About This Form
  </summary>
  <div class="collapse-content">
    <% if @form_definition.description.present? %>
      <p class="text-sm text-base-content/70 mb-4"><%= @form_definition.description %></p>
    <% end %>

    <dl class="space-y-2 text-sm">
      <div class="flex justify-between">
        <dt class="text-base-content/70">Form Code</dt>
        <dd class="font-medium"><%= @form_definition.code %></dd>
      </div>
      <% if @form_definition.page_count %>
        <div class="flex justify-between">
          <dt class="text-base-content/70">Pages</dt>
          <dd class="font-medium"><%= @form_definition.page_count %></dd>
        </div>
      <% end %>
      <div class="flex justify-between">
        <dt class="text-base-content/70">Progress</dt>
        <dd class="font-medium"><%= @submission.completion_percentage %>%</dd>
      </div>
    </dl>

    <div class="mt-4 pt-4 border-t border-base-200">
      <a href="https://selfhelp.courts.ca.gov/small-claims"
         target="_blank"
         class="link link-primary text-sm">
        Need help? Visit the Self-Help Center
      </a>
    </div>
  </div>
</details>

<%# Recommended Next Forms %>
<% recommended = @form_definition.recommended_next_forms(limit: 3) %>
<% if recommended.any? %>
  <div class="mt-8">
    <h2 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
      </svg>
      Recommended Next Forms
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
      <% recommended.each do |form| %>
        <%= link_to form_path(form.code),
            class: "card bg-base-100 shadow hover:shadow-md transition-shadow" do %>
          <div class="card-body p-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center h-10 w-10 rounded-lg bg-primary/10 text-primary font-bold text-xs shrink-0">
                <%= form.code.gsub(/[A-Z]+-/, "") %>
              </span>
              <div class="min-w-0">
                <p class="font-medium text-base-content text-sm"><%= form.code %></p>
                <p class="text-xs text-base-content/70 line-clamp-1"><%= form.title %></p>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<%# Floating Feedback Button %>
<%= render "shared/feedback_button", form_definition: @form_definition %>

<%# Keyboard Shortcuts Modal %>
<%= render "shared/keyboard_shortcuts_modal" %>

</div><%# Close view-toggle controller wrapper %>
