<%# PDF Preview Component - Reusable live preview panel %>
<div class="card bg-base-100 shadow-xl pdf-preview-card"
     data-controller="pdf-preview"
     data-pdf-preview-url-value="<%= preview_url %>"
     data-pdf-preview-debounce-delay-value="<%= debounce_delay %>"
     data-pdf-preview-auto-refresh-value="<%= auto_refresh %>"
     data-pdf-preview-field-mappings-value="<%= form_definition.field_coordinates.to_json %>"
     data-pdf-preview-xray-mode-value="false"
     role="region"
     aria-label="PDF preview for <%= form_code %>">

  <%# PDF.js Scripts %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <%# Header %>
  <div class="card-body p-4 border-b border-base-200 flex-none">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold text-base-content flex items-center gap-2">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Live Preview
      </h3>

      <div class="flex items-center gap-3">
        <%# Status indicator %>
        <span class="text-xs text-base-content/50 hidden sm:inline"
              data-pdf-preview-target="statusText"
              aria-live="polite">
          Ready
        </span>

        <%# Page Navigation %>
        <div class="flex items-center bg-base-200 rounded-lg px-1">
          <button type="button" class="btn btn-ghost btn-xs btn-square" data-action="click->pdf-preview#previousPage" data-pdf-preview-target="prevButton" aria-label="Previous Page">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
          </button>
          <span class="text-xs px-2 min-w-[3rem] text-center font-mono">
            <span data-pdf-preview-target="pageNumber">1</span> / <span data-pdf-preview-target="pageCount">?</span>
          </span>
          <button type="button" class="btn btn-ghost btn-xs btn-square" data-action="click->pdf-preview#nextPage" data-pdf-preview-target="nextButton" aria-label="Next Page">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
          </button>
        </div>

        <%# X-Ray Toggle %>
        <button type="button" 
                class="btn btn-ghost btn-xs btn-square" 
                data-action="click->pdf-preview#toggleXray"
                data-pdf-preview-target="xrayButton"
                title="Toggle X-Ray Mode (Show all fields)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>

        <%# Auto-refresh toggle %>
        <label class="flex items-center gap-2 cursor-pointer text-sm">
          <input type="checkbox"
                 class="toggle toggle-primary toggle-sm"
                 <%= "checked" if auto_refresh %>
                 data-pdf-preview-target="autoRefreshToggle"
                 data-action="change->pdf-preview#toggleAutoRefresh"
                 aria-label="Auto-refresh preview">
          <span class="text-base-content/70 hidden sm:inline">Auto</span>
        </label>

        <%# Manual refresh %>
        <button type="button"
                class="btn btn-ghost btn-circle min-h-[44px] min-w-[44px]"
                data-action="click->pdf-preview#refresh"
                title="Refresh preview"
                aria-label="Refresh PDF preview">
          <svg class="w-4 h-4" data-pdf-preview-target="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <%# Preview Container %>
  <div class="flex-1 relative bg-base-200 min-h-0">
    <%# Loading Overlay %>
    <div class="absolute inset-0 flex items-center justify-center bg-base-100/90 z-10 hidden"
         data-pdf-preview-target="loading"
         role="status"
         aria-live="polite">
      <div class="flex flex-col items-center gap-3">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <span class="text-sm text-base-content/70 font-medium">Updating preview...</span>
      </div>
    </div>

    <%# Error State %>
    <div class="absolute inset-0 flex items-center justify-center hidden"
         data-pdf-preview-target="error">
      <div class="text-center p-6">
        <svg class="w-16 h-16 mx-auto text-error/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <p class="text-base-content/70 mb-4">Failed to load preview</p>
        <button class="btn btn-primary min-h-[44px]" data-action="click->pdf-preview#refresh">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Try Again
        </button>
      </div>
    </div>

    <%# PDF Viewer Canvas Container %>
    <div class="w-full h-full overflow-auto bg-base-300 flex justify-center items-start p-4 relative"
         data-pdf-preview-target="viewer"
         tabindex="0"
         role="region"
         aria-label="PDF Canvas Viewer. Pinch to zoom.">
      <canvas data-pdf-preview-target="canvas" class="shadow-xl bg-white max-w-full" aria-hidden="true"></canvas>

      <%# Mobile Navigation Overlay - positioned at bottom %>
      <div class="md:hidden absolute bottom-4 left-0 right-0 flex justify-center pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-2 bg-base-100/95 backdrop-blur-sm rounded-full shadow-lg px-3 py-2">
          <%# Zoom Out %>
          <button type="button"
                  class="btn btn-ghost btn-circle btn-sm min-h-[40px] min-w-[40px]"
                  data-action="click->pdf-preview#zoomOut"
                  aria-label="Zoom out">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
            </svg>
          </button>

          <%# Page Info / Reset Zoom %>
          <button type="button"
                  class="btn btn-ghost btn-sm min-h-[40px] px-3 font-mono text-xs"
                  data-action="click->pdf-preview#resetZoom"
                  data-pdf-preview-target="zoomDisplay"
                  aria-label="Reset zoom to 100%">
            100%
          </button>

          <%# Zoom In %>
          <button type="button"
                  class="btn btn-ghost btn-circle btn-sm min-h-[40px] min-w-[40px]"
                  data-action="click->pdf-preview#zoomIn"
                  aria-label="Zoom in">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>

          <%# Divider %>
          <div class="w-px h-6 bg-base-300"></div>

          <%# Previous Page %>
          <button type="button"
                  class="btn btn-ghost btn-circle btn-sm min-h-[40px] min-w-[40px]"
                  data-action="click->pdf-preview#previousPage"
                  data-pdf-preview-target="mobilePrevButton"
                  aria-label="Previous page">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>

          <%# Page Number %>
          <span class="text-xs font-mono min-w-[3rem] text-center">
            <span data-pdf-preview-target="mobilePageNumber">1</span>/<span data-pdf-preview-target="mobilePageCount">?</span>
          </span>

          <%# Next Page %>
          <button type="button"
                  class="btn btn-ghost btn-circle btn-sm min-h-[40px] min-w-[40px]"
                  data-action="click->pdf-preview#nextPage"
                  data-pdf-preview-target="mobileNextButton"
                  aria-label="Next page">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>

      <%# Pinch-to-zoom hint (shown once) %>
      <div class="md:hidden absolute top-4 left-0 right-0 flex justify-center pointer-events-none transition-opacity duration-500"
           data-pdf-preview-target="pinchHint"
           id="pdf-pinch-hint-<%= form_code.parameterize %>-<%= variant %>">
        <span class="bg-base-100/90 backdrop-blur-sm text-xs px-3 py-1.5 rounded-full shadow text-base-content/70">
          Pinch to zoom
        </span>
      </div>
    </div>
  </div>

  <%# Footer Actions %>
  <div class="card-body p-4 border-t border-base-200 flex-none">
    <div class="flex gap-2">
      <%= link_to preview_url,
                  target: "_blank",
                  class: "btn btn-outline flex-1 gap-1 min-h-[44px]",
                  "aria-label": "Open PDF in new tab" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
        <span class="hidden sm:inline">Open Full</span>
      <% end %>

      <%= link_to download_url,
                  class: "btn btn-primary flex-1 gap-1 min-h-[44px]",
                  "aria-label": "Download PDF" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Download
      <% end %>
    </div>
  </div>
</div>
