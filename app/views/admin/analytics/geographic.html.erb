<% content_for :title, "Geographic Analysis - Admin" %>

<%# Breadcrumbs %>
<div class="text-sm breadcrumbs mb-4">
  <ul>
    <li><%= link_to "Admin", admin_root_path %></li>
    <li><%= link_to "Analytics", admin_analytics_path %></li>
    <li>Geographic Analysis</li>
  </ul>
</div>

<%# Header %>
<div class="mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">Geographic Usage Analysis</h1>
      <p class="text-sm md:text-base text-base-content/70">
        Platform usage across California counties.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <%= link_to admin_analytics_path, class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Dashboard
      <% end %>
    </div>
  </div>

  <p class="text-xs text-base-content/60 mt-2">
    Showing data from <%= @start_date.strftime("%b %d, %Y") %> to <%= @end_date.strftime("%b %d, %Y") %>
  </p>
</div>

<%# Period Filter %>
<div class="card bg-base-100 shadow mb-6">
  <div class="card-body p-4">
    <div class="flex flex-wrap gap-2">
      <%= link_to "7 Days",
          geographic_admin_analytics_path(period: "7d"),
          class: "btn btn-sm #{@period == '7d' ? 'btn-primary' : 'btn-ghost'}" %>
      <%= link_to "30 Days",
          geographic_admin_analytics_path(period: "30d"),
          class: "btn btn-sm #{@period == '30d' ? 'btn-primary' : 'btn-ghost'}" %>
      <%= link_to "90 Days",
          geographic_admin_analytics_path(period: "90d"),
          class: "btn btn-sm #{@period == '90d' ? 'btn-primary' : 'btn-ghost'}" %>
    </div>
  </div>
</div>

<%# Summary Stats %>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
        </svg>
      </div>
      <div class="stat-title text-xs">Active Counties</div>
      <div class="stat-value text-primary text-2xl"><%= @summary[:active_counties] %></div>
      <div class="stat-desc text-xs">of <%= @summary[:total_counties] %> counties</div>
    </div>
  </div>

  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-success">
        <div class="radial-progress text-success" style="--value:<%= @summary[:coverage_percentage] %>; --size:3rem; --thickness:4px;" role="progressbar">
          <span class="text-xs"><%= @summary[:coverage_percentage].round %>%</span>
        </div>
      </div>
      <div class="stat-title text-xs">Coverage</div>
      <div class="stat-value text-success text-2xl"><%= @summary[:coverage_percentage] %>%</div>
      <div class="stat-desc text-xs">Geographic reach</div>
    </div>
  </div>

  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
        </svg>
      </div>
      <div class="stat-title text-xs">Avg Per County</div>
      <div class="stat-value text-info text-2xl"><%= @summary[:avg_submissions_per_county] %></div>
      <div class="stat-desc text-xs">submissions/county</div>
    </div>
  </div>
</div>

<%# Regional Breakdown %>
<div class="card bg-base-100 shadow mb-6">
  <div class="card-body">
    <h2 class="card-title mb-4">Regional Breakdown</h2>

    <% if @regional.present? %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <% @regional.each do |region| %>
          <div class="card bg-base-200">
            <div class="card-body p-4">
              <h3 class="font-semibold text-sm mb-2"><%= region[:region] %></h3>
              <div class="space-y-2 text-xs">
                <div class="flex justify-between">
                  <span class="text-base-content/70">Counties:</span>
                  <span class="font-mono"><%= region[:county_count] %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-base-content/70">Submissions:</span>
                  <span class="font-mono"><%= number_with_delimiter(region[:submissions]) %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-base-content/70">Users:</span>
                  <span class="font-mono"><%= number_with_delimiter(region[:users]) %></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-base-content/70">Avg/County:</span>
                  <span class="font-mono"><%= region[:avg_per_county] %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center text-base-content/60 py-8">No regional data available</p>
    <% end %>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <%# Top Counties %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-success">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
        </svg>
        Top Counties
      </h2>

      <% if @top_counties.present? %>
        <div class="space-y-3">
          <% max_submissions = @top_counties.first[:submissions] || 1 %>
          <% @top_counties.each_with_index do |county, index| %>
            <% intensity = ((county[:submissions].to_f / max_submissions) * 100).round %>
            <div>
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2">
                  <span class="badge badge-sm badge-ghost w-6"><%= index + 1 %></span>
                  <span class="font-medium text-sm"><%= county[:county] %></span>
                </div>
                <span class="text-xs text-base-content/70"><%= number_with_delimiter(county[:submissions]) %> submissions</span>
              </div>
              <div class="w-full bg-base-200 rounded-full h-2 overflow-hidden">
                <div class="h-2 rounded-full transition-all <%= intensity > 66 ? 'bg-success' : intensity > 33 ? 'bg-info' : 'bg-warning' %>"
                     style="width: <%= intensity %>%"
                     title="<%= county[:unique_users] %> users, <%= county[:completion_rate] %>% completion rate">
                </div>
              </div>
              <div class="flex justify-between text-[10px] text-base-content/60 mt-1">
                <span><%= county[:unique_users] %> users</span>
                <span><%= county[:completion_rate] %>% completed</span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-center text-base-content/60 py-8">No county data available</p>
      <% end %>
    </div>
  </div>

  <%# Underserved Counties %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-warning">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
        Underserved Counties
      </h2>

      <% if @underserved.present? %>
        <div class="space-y-2">
          <% @underserved.first(10).each do |county| %>
            <div class="flex items-center justify-between p-2 bg-warning/10 rounded">
              <span class="text-sm font-medium"><%= county[:county] %></span>
              <div class="flex items-center gap-2">
                <span class="text-xs text-base-content/70"><%= county[:submissions] %> submissions</span>
                <span class="badge badge-warning badge-xs"><%= county[:unique_users] %> users</span>
              </div>
            </div>
          <% end %>
          <% if @underserved.count > 10 %>
            <p class="text-xs text-base-content/60 text-center mt-2">
              + <%= @underserved.count - 10 %> more counties with low usage
            </p>
          <% end %>
        </div>
      <% else %>
        <p class="text-center text-base-content/60 py-8">All active counties have good usage</p>
      <% end %>

      <% if @zero_usage.present? %>
        <div class="divider text-xs">Zero Usage</div>
        <div class="flex flex-wrap gap-1">
          <% @zero_usage.first(15).each do |county| %>
            <span class="badge badge-ghost badge-sm"><%= county %></span>
          <% end %>
          <% if @zero_usage.count > 15 %>
            <span class="badge badge-ghost badge-sm">+<%= @zero_usage.count - 15 %> more</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# All Counties Heatmap %>
<div class="card bg-base-100 shadow">
  <div class="card-body">
    <h2 class="card-title mb-4">County Usage Heatmap</h2>

    <% if @counties.present? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full text-sm">
          <thead>
            <tr>
              <th>County</th>
              <th class="text-right">Submissions</th>
              <th class="text-right">Users</th>
              <th class="text-right">Completions</th>
              <th>Usage Intensity</th>
            </tr>
          </thead>
          <tbody>
            <% max_submissions = @counties.first[:submissions] || 1 %>
            <% @counties.each do |county| %>
              <% intensity = ((county[:submissions].to_f / max_submissions) * 100).round %>
              <tr>
                <td class="font-medium"><%= county[:county] %></td>
                <td class="text-right font-mono"><%= number_with_delimiter(county[:submissions]) %></td>
                <td class="text-right font-mono"><%= number_with_delimiter(county[:unique_users]) %></td>
                <td class="text-right">
                  <span class="badge badge-sm <%= county[:completion_rate] > 70 ? 'badge-success' : county[:completion_rate] > 40 ? 'badge-info' : 'badge-warning' %>">
                    <%= county[:completion_rate] %>%
                  </span>
                </td>
                <td>
                  <div class="flex items-center gap-2">
                    <div class="w-24 bg-base-200 rounded-full h-2 overflow-hidden">
                      <div class="h-2 rounded-full <%= intensity > 66 ? 'bg-success' : intensity > 33 ? 'bg-info' : 'bg-warning' %>"
                           style="width: <%= intensity %>%">
                      </div>
                    </div>
                    <span class="text-xs text-base-content/60"><%= intensity %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-center text-base-content/60 py-8">No geographic data available</p>
    <% end %>
  </div>
</div>
