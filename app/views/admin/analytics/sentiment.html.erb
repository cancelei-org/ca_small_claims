<% content_for :title, "Sentiment Analysis - Admin" %>

<%# Breadcrumbs %>
<div class="text-sm breadcrumbs mb-4">
  <ul>
    <li><%= link_to "Admin", admin_root_path %></li>
    <li><%= link_to "Analytics", admin_analytics_path %></li>
    <li>Sentiment Analysis</li>
  </ul>
</div>

<%# Header %>
<div class="mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">Feedback Sentiment Analysis</h1>
      <p class="text-sm md:text-base text-base-content/70">
        Analyze user feedback sentiment and identify common themes.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <%= link_to admin_analytics_path, class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Dashboard
      <% end %>
    </div>
  </div>

  <p class="text-xs text-base-content/60 mt-2">
    Showing data from <%= @start_date.strftime("%b %d, %Y") %> to <%= @end_date.strftime("%b %d, %Y") %>
  </p>
</div>

<%# Alerts %>
<% if @alerts.present? %>
  <% @alerts.each do |alert| %>
    <div class="alert <%= alert[:severity] == 'high' ? 'alert-error' : 'alert-warning' %> shadow mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div>
        <h3 class="font-bold"><%= alert[:type].to_s.titleize %></h3>
        <div class="text-sm"><%= alert[:message] %></div>
      </div>
    </div>
  <% end %>
<% end %>

<%# Filters %>
<div class="card bg-base-100 shadow mb-6">
  <div class="card-body p-4">
    <div class="flex flex-col md:flex-row gap-4">
      <%# Period Filter %>
      <div class="flex flex-wrap gap-2">
        <%= link_to "7 Days",
            sentiment_admin_analytics_path(period: "7d", form_id: @form_definition_id),
            class: "btn btn-sm #{@period == '7d' ? 'btn-primary' : 'btn-ghost'}" %>
        <%= link_to "30 Days",
            sentiment_admin_analytics_path(period: "30d", form_id: @form_definition_id),
            class: "btn btn-sm #{@period == '30d' ? 'btn-primary' : 'btn-ghost'}" %>
        <%= link_to "90 Days",
            sentiment_admin_analytics_path(period: "90d", form_id: @form_definition_id),
            class: "btn btn-sm #{@period == '90d' ? 'btn-primary' : 'btn-ghost'}" %>
      </div>

      <%# Form Filter %>
      <div class="flex-1 md:max-w-xs">
        <%= form_with url: sentiment_admin_analytics_path, method: :get, local: true, class: "flex gap-2" do %>
          <%= hidden_field_tag :period, @period %>
          <%= select_tag :form_id,
              options_for_select([["All Forms", ""]] + @forms.map { |f| ["#{f.code} - #{f.title}", f.id] }, @form_definition_id),
              class: "select select-sm select-bordered flex-1",
              onchange: "this.form.submit()" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# Summary Stats %>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure">
        <div class="radial-progress <%= @summary[:sentiment_score] >= 60 ? 'text-success' : @summary[:sentiment_score] >= 40 ? 'text-warning' : 'text-error' %>"
             style="--value:<%= @summary[:sentiment_score] %>; --size:3rem; --thickness:4px;"
             role="progressbar">
          <span class="text-xs"><%= @summary[:sentiment_score].round %>%</span>
        </div>
      </div>
      <div class="stat-title text-xs">Sentiment Score</div>
      <div class="stat-value <%= @summary[:sentiment_score] >= 60 ? 'text-success' : @summary[:sentiment_score] >= 40 ? 'text-warning' : 'text-error' %> text-2xl">
        <%= @summary[:sentiment_score] %>
      </div>
      <div class="stat-desc text-xs">Out of 100</div>
    </div>
  </div>

  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-success">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
          <path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 016 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 012.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 00.322-1.672V3a.75.75 0 01.75-.75 2.25 2.25 0 012.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558-.632 1.078-1.09 1.551a14.717 14.717 0 01-2.663 2.117c-1.099.611-1.737 1.658-1.737 2.835v.75c0 .414.336.75.75.75h4.5a.75.75 0 010 1.5h-4.5a2.25 2.25 0 01-2.25-2.25v-.75c0-2.027 1.099-3.887 2.861-4.848a13.216 13.216 0 002.397-1.906c.329-.347.579-.735.739-1.145.227-.577.35-1.21.35-1.868 0-.137-.009-.27-.026-.402a4.497 4.497 0 01-2.224 5.025c-.49.284-1.03.474-1.59.563a.75.75 0 01-.183-.017c-.702-.115-1.297-.536-1.638-1.102-.291-.483-.38-1.032-.216-1.543a.75.75 0 01.183-.367c.275-.35.673-.633 1.127-.82a2.998 2.998 0 001.69-1.69 4.508 4.508 0 00.368-1.822c0-.83-.336-1.582-.879-2.125A2.993 2.993 0 0015 3.75a.75.75 0 01-.75.75h-.75a.75.75 0 010-1.5H15c.413 0 .75.336.75.75 0 .137-.009.27-.026.402-.07.555-.341 1.048-.737 1.404a1.5 1.5 0 01-1.987-.05 4.503 4.503 0 00-4.998 0 1.5 1.5 0 01-1.987.05 2.245 2.245 0 01-.737-1.404A.754.754 0 015.25 4.5c0-.414.337-.75.75-.75h1.5a.75.75 0 010 1.5H6.75a.75.75 0 01-.75-.75c0-.69.168-1.342.465-1.916a3.742 3.742 0 011.414-1.558A2.985 2.985 0 009 3.75c.828 0 1.582.336 2.125.879s.879 1.297.879 2.125a3 3 0 01-.368 1.822 2.998 2.998 0 01-1.69 1.69 2.256 2.256 0 00-1.127.82.75.75 0 01-.183.367 2.249 2.249 0 00.216 1.543c.34.566.936.987 1.638 1.102.06.008.121.013.183.017a3.74 3.74 0 001.59-.563 4.497 4.497 0 002.224-5.025.754.754 0 00-.026.402c0 .658-.123 1.291-.35 1.868-.16.41-.41.798-.739 1.145a13.216 13.216 0 01-2.397 1.906c-1.762.961-2.861 2.82-2.861 4.848v.75c0 1.242 1.008 2.25 2.25 2.25h4.5a.75.75 0 000-1.5h-4.5a.75.75 0 01-.75-.75v-.75c0-1.177.638-2.224 1.737-2.835.645-.358 1.362-.808 2.004-1.348a2.74 2.74 0 001.09-1.551c.463-.975.723-2.066.723-3.218A2.25 2.25 0 0015 2.25a.75.75 0 00-.75.75v.093c0 .582-.11 1.148-.322 1.672-.303.759-.93 1.33-1.653 1.715a9.042 9.042 0 00-2.861 2.4c-.322.41-.739.741-1.212.924a1.489 1.489 0 00-.6.397A7.48 7.48 0 006 15.375c0 .997.195 1.95.518 2.743.155.396.55.632.975.632z"/>
        </svg>
      </div>
      <div class="stat-title text-xs">Positive</div>
      <div class="stat-value text-success text-2xl"><%= @summary[:positive_percentage] %>%</div>
      <div class="stat-desc text-xs"><%= @summary[:positive_count] %> feedbacks</div>
    </div>
  </div>

  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-warning">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
        </svg>
      </div>
      <div class="stat-title text-xs">Neutral</div>
      <div class="stat-value text-warning text-2xl"><%= @summary[:neutral_count] %></div>
      <div class="stat-desc text-xs">feedbacks</div>
    </div>
  </div>

  <div class="stats shadow bg-base-100">
    <div class="stat p-4">
      <div class="stat-figure text-error">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
        </svg>
      </div>
      <div class="stat-title text-xs">Negative</div>
      <div class="stat-value text-error text-2xl"><%= @summary[:negative_count] %></div>
      <div class="stat-desc text-xs">feedbacks</div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <%# Sentiment Trend %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">Sentiment Trend</h2>

      <% if @trends.present? %>
        <div class="h-64 flex items-end gap-1">
          <% @trends.each do |trend| %>
            <% height = trend[:score] %>
            <% color = trend[:score] >= 60 ? 'bg-success' : trend[:score] >= 40 ? 'bg-warning' : 'bg-error' %>
            <div class="flex-1 flex flex-col items-center group relative">
              <div class="w-full <%= color %>/30 hover:<%= color %>/50 transition-colors rounded-t" style="height: <%= height %>%;">
                <div class="opacity-0 group-hover:opacity-100 absolute -top-16 left-1/2 -translate-x-1/2 bg-base-300 text-xs px-2 py-1 rounded shadow pointer-events-none whitespace-nowrap z-10">
                  <%= trend[:date].strftime("%b %d") %><br>
                  Score: <%= trend[:score] %><br>
                  <%= trend[:count] %> feedbacks
                </div>
              </div>
              <% if @trends.length <= 14 || trend[:date].day == 1 || trend == @trends.first || trend == @trends.last %>
                <div class="text-[8px] text-base-content/60 mt-2 -rotate-45 origin-top-left translate-y-2">
                  <%= trend[:date].strftime("%m/%d") %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-center text-base-content/60 py-8">No trend data available</p>
      <% end %>
    </div>
  </div>

  <%# Rating Distribution %>
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">Rating Distribution</h2>

      <% if @rating_distribution.present? %>
        <div class="space-y-3">
          <% @rating_distribution.reverse.each do |rating| %>
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm flex items-center gap-2">
                  <% rating[:rating].times do %>
                    <svg class="w-3 h-3 fill-warning" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                  <% end %>
                  <%= rating[:label] %>
                </span>
                <span class="text-sm text-base-content/70"><%= rating[:count] %> (<%= rating[:percentage] %>%)</span>
              </div>
              <progress class="progress progress-<%= rating[:rating] >= 4 ? 'success' : rating[:rating] >= 3 ? 'info' : 'error' %> w-full"
                        value="<%= rating[:percentage] %>"
                        max="100">
              </progress>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-center text-base-content/60 py-8">No rating data available</p>
      <% end %>
    </div>
  </div>
</div>

<%# Common Themes %>
<div class="card bg-base-100 shadow mb-6">
  <div class="card-body">
    <h2 class="card-title mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
      </svg>
      Common Themes in Feedback
    </h2>

    <% if @themes.present? %>
      <div class="flex flex-wrap gap-2">
        <% @themes.each do |theme| %>
          <div class="badge badge-lg gap-2 <%= theme[:sentiment] == :positive ? 'badge-success' : theme[:sentiment] == :negative ? 'badge-error' : 'badge-neutral' %>">
            <%= theme[:theme] %>
            <span class="badge badge-sm badge-ghost"><%= theme[:count] %></span>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center text-base-content/60 py-8">No themes identified</p>
    <% end %>
  </div>
</div>

<%# Issues by Sentiment %>
<div class="card bg-base-100 shadow">
  <div class="card-body">
    <h2 class="card-title mb-4">Issues by Sentiment</h2>

    <% if @issues.present? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Issue Type</th>
              <th class="text-center">Positive</th>
              <th class="text-center">Neutral</th>
              <th class="text-center">Negative</th>
              <th class="text-right">Total</th>
              <th>Negative %</th>
            </tr>
          </thead>
          <tbody>
            <% @issues.each do |issue| %>
              <tr class="<%= issue[:negative_percentage] > 66 ? 'bg-error/10' : issue[:negative_percentage] > 33 ? 'bg-warning/10' : '' %>">
                <td class="font-medium"><%= issue[:issue_label] %></td>
                <td class="text-center"><span class="badge badge-success badge-sm"><%= issue[:positive] %></span></td>
                <td class="text-center"><span class="badge badge-neutral badge-sm"><%= issue[:neutral] %></span></td>
                <td class="text-center"><span class="badge badge-error badge-sm"><%= issue[:negative] %></span></td>
                <td class="text-right font-mono"><%= issue[:total] %></td>
                <td>
                  <div class="flex items-center gap-2">
                    <progress class="progress progress-error w-16" value="<%= issue[:negative_percentage] %>" max="100"></progress>
                    <span class="text-sm"><%= issue[:negative_percentage] %>%</span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-center text-base-content/60 py-8">No issue data available</p>
    <% end %>
  </div>
</div>
