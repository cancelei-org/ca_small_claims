<%= form_with model: product_feedback, local: false, html: { class: "space-y-6", data: { controller: "product-feedback" } } do |f| %>
  <% if product_feedback.errors.any? %>
    <div role="alert" class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <h3 class="font-bold">Please fix the following errors:</h3>
        <ul class="list-disc list-inside">
          <% product_feedback.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="form-control">
    <%= f.label :category, "What type of feedback is this?", class: "label" %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <% ProductFeedback.categories.keys.each do |cat| %>
        <label class="cursor-pointer">
          <input type="radio"
                 name="product_feedback[category]"
                 value="<%= cat %>"
                 class="peer hidden"
                 <%= "checked" if product_feedback.category == cat || (product_feedback.category.nil? && cat == "general") %>
                 data-action="change->product-feedback#updateCategory">
          <div class="card bg-base-200 peer-checked:bg-primary peer-checked:text-primary-content p-4 text-center transition-colors">
            <div class="text-2xl mb-2"><%= category_emoji(cat) %></div>
            <div class="font-medium text-sm"><%= ProductFeedback.category_display_name(cat) %></div>
          </div>
        </label>
      <% end %>
    </div>
  </div>

  <div class="form-control">
    <%= f.label :title, class: "label" do %>
      <span class="label-text">Title <span class="text-error">*</span></span>
      <span class="label-text-alt"><span data-product-feedback-target="titleCount">0</span>/200</span>
    <% end %>
    <%= f.text_field :title,
                     class: "input input-bordered w-full #{product_feedback.errors[:title].any? ? 'input-error' : ''}",
                     maxlength: 200,
                     placeholder: "Brief summary of your feedback",
                     required: true,
                     data: { action: "input->product-feedback#updateTitleCount", product_feedback_target: "titleInput" } %>
    <% if product_feedback.errors[:title].any? %>
      <label class="label">
        <span class="label-text-alt text-error"><%= product_feedback.errors[:title].first %></span>
      </label>
    <% end %>
  </div>

  <div class="form-control">
    <%= f.label :description, class: "label" do %>
      <span class="label-text">Description <span class="text-error">*</span></span>
      <span class="label-text-alt"><span data-product-feedback-target="descCount">0</span>/5000</span>
    <% end %>
    <%= f.text_area :description,
                    class: "textarea textarea-bordered w-full h-40 #{product_feedback.errors[:description].any? ? 'textarea-error' : ''}",
                    maxlength: 5000,
                    placeholder: "Please provide as much detail as possible. For bug reports, include steps to reproduce the issue.",
                    required: true,
                    data: { action: "input->product-feedback#updateDescCount", product_feedback_target: "descInput" } %>
    <% if product_feedback.errors[:description].any? %>
      <label class="label">
        <span class="label-text-alt text-error"><%= product_feedback.errors[:description].first %></span>
      </label>
    <% end %>
  </div>

  <div class="form-control">
    <%= f.label :attachments, class: "label" do %>
      <span class="label-text">Attachments (optional)</span>
      <span class="label-text-alt">Up to 5 images, max 5MB each</span>
    <% end %>
    <%= f.file_field :attachments,
                     multiple: true,
                     accept: "image/png,image/jpeg,image/gif,image/webp",
                     class: "file-input file-input-bordered w-full",
                     data: { action: "change->product-feedback#validateAttachments" } %>
    <label class="label">
      <span class="label-text-alt">Screenshots help us understand the issue better</span>
    </label>
  </div>

  <div class="flex justify-end gap-4 pt-4">
    <%= link_to "Cancel", product_feedbacks_path, class: "btn btn-ghost" %>
    <%= f.submit "Submit Feedback", class: "btn btn-primary" %>
  </div>
<% end %>
