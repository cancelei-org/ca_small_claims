<% content_for :title, "Analytics Dashboard - Admin" %>

<div class="mb-6 md:mb-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-base-content mb-2">Analytics Dashboard</h1>
      <p class="text-sm md:text-base text-base-content/70">
        Insights into platform usage and form performance.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <%# Funnel Analysis Link %>
      <%= link_to funnel_admin_analytics_path(period: @period, start_date: @start_date, end_date: @end_date), class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0012 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 01-2.031.352 5.988 5.988 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 01-2.031.352 5.989 5.989 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971z" />
        </svg>
        Funnel
      <% end %>

      <%# Time Metrics Link %>
      <%= link_to time_metrics_admin_analytics_path(period: @period, start_date: @start_date, end_date: @end_date), class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Time Metrics
      <% end %>

      <%# Drop-Off Analysis Link %>
      <%= link_to drop_off_admin_analytics_path(period: @period, start_date: @start_date, end_date: @end_date), class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
        </svg>
        Drop-Off
      <% end %>

      <%# Geographic Analysis Link %>
      <%= link_to geographic_admin_analytics_path(period: @period, start_date: @start_date, end_date: @end_date), class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
        </svg>
        Geographic
      <% end %>

      <%# Sentiment Analysis Link %>
      <%= link_to sentiment_admin_analytics_path(period: @period, start_date: @start_date, end_date: @end_date), class: "btn btn-sm btn-ghost gap-1" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
        </svg>
        Sentiment
      <% end %>

      <%# Export dropdown %>
      <div class="dropdown dropdown-end">
        <label tabindex="0" class="btn btn-sm btn-ghost gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
          Export
        </label>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40">
          <li>
            <%= link_to export_admin_analytics_path(format: :csv, period: @period, start_date: @start_date, end_date: @end_date) do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
              </svg>
              CSV Format
            <% end %>
          </li>
          <li class="disabled">
            <a class="tooltip tooltip-left" data-tip="Requires prawn gem">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
              </svg>
              PDF Format
            </a>
          </li>
        </ul>
      </div>
    </div>

    <%# Date Range Selector %>
    <div class="flex flex-wrap gap-2">
      <%= link_to "7 Days",
          admin_analytics_path(period: "7d"),
          class: "btn btn-sm #{@period == '7d' ? 'btn-primary' : 'btn-ghost'}" %>
      <%= link_to "30 Days",
          admin_analytics_path(period: "30d"),
          class: "btn btn-sm #{@period == '30d' ? 'btn-primary' : 'btn-ghost'}" %>
      <%= link_to "90 Days",
          admin_analytics_path(period: "90d"),
          class: "btn btn-sm #{@period == '90d' ? 'btn-primary' : 'btn-ghost'}" %>

      <div class="dropdown dropdown-end">
        <label tabindex="0" class="btn btn-sm btn-ghost gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          Custom
        </label>
        <div tabindex="0" class="dropdown-content z-[1] card card-compact w-72 p-2 shadow bg-base-100">
          <div class="card-body">
            <%= form_with url: admin_analytics_path, method: :get, local: true, class: "space-y-3" do %>
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs">Start Date</span></label>
                <%= date_field_tag :start_date, @analytics.start_date, class: "input input-sm input-bordered w-full" %>
              </div>
              <div class="form-control">
                <label class="label py-1"><span class="label-text text-xs">End Date</span></label>
                <%= date_field_tag :end_date, @analytics.end_date, class: "input input-sm input-bordered w-full" %>
              </div>
              <%= submit_tag "Apply", class: "btn btn-sm btn-primary w-full" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p class="text-xs text-base-content/60 mt-2">
    Showing data from <%= @analytics.start_date.strftime("%b %d, %Y") %> to <%= @analytics.end_date.strftime("%b %d, %Y") %>
  </p>
</div>

<%# Summary Stats - Horizontal scroll on mobile, grid on desktop %>
<div class="overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 md:overflow-visible mb-6 md:mb-8" tabindex="0" role="region" aria-label="Analytics statistics">
  <div class="flex md:grid md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 min-w-max md:min-w-0">
    <%# Total Submissions %>
    <div class="stats shadow bg-base-100 flex-shrink-0 w-[160px] md:w-auto">
      <div class="stat p-4 md:p-6">
        <div class="stat-figure text-primary hidden md:block">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
        </div>
        <div class="stat-title text-xs md:text-sm">Total Submissions</div>
        <div class="stat-value text-primary text-2xl md:text-4xl"><%= number_with_delimiter(@summary[:total_submissions]) %></div>
        <div class="stat-desc text-xs flex items-center gap-1">
          <% if @comparison[:submissions_change] > 0 %>
            <span class="text-success">+<%= @comparison[:submissions_change] %>%</span>
          <% elsif @comparison[:submissions_change] < 0 %>
            <span class="text-error"><%= @comparison[:submissions_change] %>%</span>
          <% else %>
            <span class="text-base-content/60">0%</span>
          <% end %>
          vs previous period
        </div>
      </div>
    </div>

    <%# Completed %>
    <div class="stats shadow bg-base-100 flex-shrink-0 w-[160px] md:w-auto">
      <div class="stat p-4 md:p-6">
        <div class="stat-figure text-success hidden md:block">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-title text-xs md:text-sm">Completed</div>
        <div class="stat-value text-success text-2xl md:text-4xl"><%= number_with_delimiter(@summary[:completed_submissions]) %></div>
        <div class="stat-desc text-xs flex items-center gap-1">
          <% if @comparison[:completions_change] > 0 %>
            <span class="text-success">+<%= @comparison[:completions_change] %>%</span>
          <% elsif @comparison[:completions_change] < 0 %>
            <span class="text-error"><%= @comparison[:completions_change] %>%</span>
          <% else %>
            <span class="text-base-content/60">0%</span>
          <% end %>
          vs previous period
        </div>
      </div>
    </div>

    <%# Completion Rate %>
    <div class="stats shadow bg-base-100 flex-shrink-0 w-[160px] md:w-auto">
      <div class="stat p-4 md:p-6">
        <div class="stat-figure text-info hidden md:block">
          <div class="radial-progress text-info" style="--value:<%= @summary[:completion_rate] %>; --size:3rem; --thickness:4px;" role="progressbar">
            <span class="text-xs"><%= @summary[:completion_rate].round %>%</span>
          </div>
        </div>
        <div class="stat-title text-xs md:text-sm">Completion Rate</div>
        <div class="stat-value text-info text-2xl md:text-4xl"><%= @summary[:completion_rate] %>%</div>
        <div class="stat-desc text-xs">Drafts vs Completed</div>
      </div>
    </div>

    <%# PDF Downloads %>
    <div class="stats shadow bg-base-100 flex-shrink-0 w-[160px] md:w-auto">
      <div class="stat p-4 md:p-6">
        <div class="stat-figure text-secondary hidden md:block">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        </div>
        <div class="stat-title text-xs md:text-sm">PDF Downloads</div>
        <div class="stat-value text-secondary text-2xl md:text-4xl"><%= number_with_delimiter(@summary[:total_downloads]) %></div>
        <div class="stat-desc text-xs">Forms generated</div>
      </div>
    </div>
  </div>
</div>

<%# Mobile hint for scrolling stats %>
<p class="text-xs text-base-content/60 text-center md:hidden -mt-4 mb-4">
  Swipe to see all stats
</p>

<%# Secondary Stats Row %>
<div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6 md:mb-8">
  <div class="stats shadow bg-base-100">
    <div class="stat p-3 md:p-4">
      <div class="stat-title text-xs">Registered Users</div>
      <div class="stat-value text-lg md:text-2xl"><%= number_with_delimiter(@summary[:unique_users]) %></div>
    </div>
  </div>
  <div class="stats shadow bg-base-100">
    <div class="stat p-3 md:p-4">
      <div class="stat-title text-xs">Anonymous Sessions</div>
      <div class="stat-value text-lg md:text-2xl"><%= number_with_delimiter(@summary[:anonymous_sessions]) %></div>
    </div>
  </div>
  <div class="stats shadow bg-base-100 col-span-2 md:col-span-1">
    <div class="stat p-3 md:p-4">
      <div class="stat-title text-xs">Drafts in Progress</div>
      <div class="stat-value text-lg md:text-2xl text-warning"><%= number_with_delimiter(@summary[:draft_submissions]) %></div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
  <%# Daily Activity Chart %>
  <details class="md:open group" open>
    <summary class="md:hidden flex items-center justify-between p-4 bg-base-100 shadow rounded-lg cursor-pointer min-h-[56px] list-none">
      <span class="flex items-center gap-2 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
        </svg>
        Daily Activity
      </span>
      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </summary>

    <div class="card bg-base-100 shadow mt-2 md:mt-0">
      <div class="card-body p-4 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="card-title text-base md:text-lg hidden md:flex">Daily Activity</h2>
          <div class="flex gap-4 text-xs">
            <span class="flex items-center gap-1">
              <span class="w-3 h-3 rounded bg-primary"></span> Submissions
            </span>
            <span class="flex items-center gap-1">
              <span class="w-3 h-3 rounded bg-success"></span> Completions
            </span>
          </div>
        </div>

        <div class="h-48 md:h-64 flex items-end gap-[2px] md:gap-1">
          <% max_val = [(@daily_submissions.values.max || 0), (@daily_completions.values.max || 0), 1].max %>
          <% @daily_submissions.each do |date, count| %>
            <% completion_count = @daily_completions[date] || 0 %>
            <% sub_height = (count.to_f / max_val * 100).round %>
            <% comp_height = (completion_count.to_f / max_val * 100).round %>
            <div class="flex-1 flex flex-col items-center group relative">
              <div class="w-full flex gap-[1px]">
                <%# Submissions bar %>
                <div class="flex-1 bg-primary/30 hover:bg-primary/50 transition-colors rounded-t-sm relative" style="height: <%= [sub_height, 2].max %>px; min-height: 2px;">
                </div>
                <%# Completions bar %>
                <div class="flex-1 bg-success/30 hover:bg-success/50 transition-colors rounded-t-sm" style="height: <%= [comp_height, 2].max %>px; min-height: 2px;">
                </div>
              </div>
              <%# Tooltip %>
              <div class="opacity-0 group-hover:opacity-100 absolute -top-12 left-1/2 -translate-x-1/2 bg-base-300 text-xs px-2 py-1 rounded shadow pointer-events-none whitespace-nowrap z-10">
                <div><%= date.strftime("%b %d") %></div>
                <div class="text-primary"><%= count %> subs</div>
                <div class="text-success"><%= completion_count %> done</div>
              </div>
              <% if @daily_submissions.keys.length <= 14 || date.day == 1 || date == @daily_submissions.keys.first || date == @daily_submissions.keys.last %>
                <div class="text-[8px] md:text-[10px] text-base-content/60 mt-2 -rotate-45 origin-top-left translate-y-2"><%= date.strftime("%b %d") %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </details>

  <%# Status Breakdown %>
  <details class="md:open group" open>
    <summary class="md:hidden flex items-center justify-between p-4 bg-base-100 shadow rounded-lg cursor-pointer min-h-[56px] list-none">
      <span class="flex items-center gap-2 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-secondary">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" />
        </svg>
        Status Breakdown
      </span>
      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </summary>

    <div class="card bg-base-100 shadow mt-2 md:mt-0">
      <div class="card-body p-4 md:p-6">
        <h2 class="card-title text-base md:text-lg mb-4 hidden md:flex">Status Breakdown</h2>

        <% total_status = @status_breakdown.values.sum %>
        <% if total_status > 0 %>
          <div class="space-y-4">
            <% [
              { key: :draft, label: "Draft", color: "warning" },
              { key: :completed, label: "Completed", color: "success" },
              { key: :submitted, label: "Submitted", color: "info" }
            ].each do |status| %>
              <% count = @status_breakdown[status[:key]] || 0 %>
              <% percentage = (count.to_f / total_status * 100).round(1) %>
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium"><%= status[:label] %></span>
                  <span class="text-sm text-base-content/70"><%= number_with_delimiter(count) %> (<%= percentage %>%)</span>
                </div>
                <progress class="progress progress-<%= status[:color] %> w-full" value="<%= percentage %>" max="100"></progress>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-center text-base-content/60 py-8">No submissions in this period</p>
        <% end %>
      </div>
    </div>
  </details>
</div>

<%# Popular Forms %>
<details class="md:open group mb-6 md:mb-8" open>
  <summary class="md:hidden flex items-center justify-between p-4 bg-base-100 shadow rounded-lg cursor-pointer min-h-[56px] list-none">
    <span class="flex items-center gap-2 font-semibold">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
      </svg>
      Popular Forms
      <% if @popular_forms.any? %>
        <span class="badge badge-ghost badge-sm"><%= @popular_forms.count %></span>
      <% end %>
    </span>
    <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </summary>

  <div class="card bg-base-100 shadow mt-2 md:mt-0">
    <div class="card-body p-4 md:p-6">
      <h2 class="card-title text-base md:text-lg mb-4 hidden md:flex">Popular Forms</h2>

      <% if @popular_forms.any? %>
        <%# Mobile: Card list %>
        <div class="md:hidden space-y-2">
          <% @popular_forms.each_with_index do |form, index| %>
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="badge badge-primary badge-sm w-6 h-6 p-0 flex items-center justify-center font-bold"><%= index + 1 %></span>
                <div>
                  <span class="font-medium"><%= form[:code] %></span>
                  <div class="text-xs text-base-content/60 truncate max-w-[150px]"><%= form[:title] %></div>
                </div>
              </div>
              <div class="text-right">
                <div class="font-mono text-sm"><%= form[:count] %></div>
                <div class="flex items-center gap-1 text-xs">
                  <% if form[:trend] == :up %>
                    <span class="text-success">↑</span>
                  <% elsif form[:trend] == :down %>
                    <span class="text-error">↓</span>
                  <% else %>
                    <span class="text-base-content/60">→</span>
                  <% end %>
                  <span class="text-base-content/60"><%= form[:completion_rate] %>%</span>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <%# Desktop: Table %>
        <div class="hidden md:block overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th class="w-12">Rank</th>
                <th>Form</th>
                <th class="text-right">Submissions</th>
                <th class="text-right">Completion Rate</th>
                <th class="text-center">Trend</th>
              </tr>
            </thead>
            <tbody>
              <% @popular_forms.each_with_index do |form, index| %>
                <tr>
                  <th><%= index + 1 %></th>
                  <td>
                    <div class="font-medium"><%= form[:code] %></div>
                    <div class="text-xs text-base-content/60"><%= form[:title] %></div>
                  </td>
                  <td class="text-right font-mono"><%= number_with_delimiter(form[:count]) %></td>
                  <td class="text-right">
                    <div class="flex items-center justify-end gap-2">
                      <progress class="progress progress-success w-16" value="<%= form[:completion_rate] %>" max="100"></progress>
                      <span class="text-sm"><%= form[:completion_rate] %>%</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <% if form[:trend] == :up %>
                      <span class="badge badge-success badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
                        </svg>
                        Up
                      </span>
                    <% elsif form[:trend] == :down %>
                      <span class="badge badge-error badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                        Down
                      </span>
                    <% else %>
                      <span class="badge badge-ghost badge-sm">Stable</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-center text-base-content/60 py-8">No form submissions in this period</p>
      <% end %>
    </div>
  </div>
</details>

<%# Activity Patterns %>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
  <%# Hourly Activity %>
  <details class="md:open group" open>
    <summary class="md:hidden flex items-center justify-between p-4 bg-base-100 shadow rounded-lg cursor-pointer min-h-[56px] list-none">
      <span class="flex items-center gap-2 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Hourly Activity
      </span>
      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </summary>

    <div class="card bg-base-100 shadow mt-2 md:mt-0">
      <div class="card-body p-4 md:p-6">
        <h2 class="card-title text-base md:text-lg mb-4 hidden md:flex">Activity by Hour</h2>

        <div class="h-32 flex items-end gap-[1px]">
          <% max_hourly = [(@hourly_activity.values.max || 0), 1].max %>
          <% @hourly_activity.each do |hour, count| %>
            <% height = (count.to_f / max_hourly * 100).round %>
            <div class="flex-1 flex flex-col items-center group relative">
              <div class="w-full bg-info/30 hover:bg-info/50 transition-colors rounded-t-sm" style="height: <%= [height, 2].max %>%;">
                <div class="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-base-300 text-xs px-2 py-1 rounded shadow pointer-events-none whitespace-nowrap z-10">
                  <%= hour %>:00 - <%= count %>
                </div>
              </div>
              <% if hour % 6 == 0 %>
                <div class="text-[8px] text-base-content/60 mt-1"><%= hour %></div>
              <% end %>
            </div>
          <% end %>
        </div>
        <p class="text-xs text-base-content/60 text-center mt-2">Hour of day (24h format)</p>
      </div>
    </div>
  </details>

  <%# Weekly Activity %>
  <details class="md:open group" open>
    <summary class="md:hidden flex items-center justify-between p-4 bg-base-100 shadow rounded-lg cursor-pointer min-h-[56px] list-none">
      <span class="flex items-center gap-2 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-secondary">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
        </svg>
        Weekly Activity
      </span>
      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </summary>

    <div class="card bg-base-100 shadow mt-2 md:mt-0">
      <div class="card-body p-4 md:p-6">
        <h2 class="card-title text-base md:text-lg mb-4 hidden md:flex">Activity by Day of Week</h2>

        <% max_weekly = [(@weekly_activity.values.max || 0), 1].max %>
        <div class="space-y-2">
          <% %w[Monday Tuesday Wednesday Thursday Friday Saturday Sunday].each do |day| %>
            <% count = @weekly_activity[day] || 0 %>
            <% percentage = (count.to_f / max_weekly * 100).round %>
            <div class="flex items-center gap-3">
              <span class="text-xs w-10 text-right text-base-content/70"><%= day[0..2] %></span>
              <div class="flex-1 h-4 bg-base-200 rounded-full overflow-hidden">
                <div class="h-full bg-secondary/50 rounded-full transition-all" style="width: <%= percentage %>%"></div>
              </div>
              <span class="text-xs w-8 font-mono"><%= count %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </details>
</div>
